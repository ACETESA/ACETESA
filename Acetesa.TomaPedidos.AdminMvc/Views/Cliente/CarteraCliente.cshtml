
@{
    ViewBag.Title = "Cartera Cliente";
}

<div class="container">

    <div class="card mb-3">
        <div class="card-header bg-success text-white">
            <h3>
                Gestión de Cartera de Clientes
            </h3>
        </div>
        <div class="card-body bg-light">
            <a class="btn btn-success" onclick="tableToExcel();"><i class="fa fa-file-excel-o"></i> Excel</a>
        </div>
    </div>

    <div class="table-responsive">
        <table id="table-clientesAsignadosLibres" class="table table-striped w-100">
            <thead class="bg-secondary text-white">
                <tr style="font-weight:bold;">
                    <td style="text-align:center; border-right:dashed 0.2px #214820;">Asignado</td>
                    <td style="display:none;">Asignado</td>
                    <td style="text-align:center; border-right:dashed 0.2px #214820;">#</td>
                    <td style="text-align:center; border-right:dashed 0.2px #214820;">Ruc</td>
                    <td style="text-align:center; border-right:dashed 0.2px #214820;">Razón Social</td>
                    <td style="text-align:center; border-right:dashed 0.2px #214820;">Sector</td>
                    <td style="text-align:center; border-right:dashed 0.2px #214820;">Aseguradora</td>
                    <td style="text-align:center; border-right:dashed 0.2px #214820;">Límite</td>
                    <td style="text-align:center; border-right:dashed 0.2px #214820;">Departamento</td>
                    <td style="text-align:center; border-right:dashed 0.2px #214820;">Provincia</td>
                    <td style="text-align:center;">Distrito</td>
                </tr>
            </thead>
            <tbody style=""></tbody>
        </table>
    </div>
</div>


@section CssTop{
    @Styles.Render("~/Content/ui")
    <link href="~/Content/toastr.min.css" rel="stylesheet" />
    <link href="~/Content/bootstrap.min.css" rel="stylesheet" />
    @*<link href="~/Content/bootstrap-select.min.css" rel="stylesheet" />*@
}
@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/jqueryui")
    <script src="~/Scripts/jquery.maskedinput.min.js"></script>
    @*<script src="~/Scripts/jquery.dataTables.min.js"></script>*@
    <script src="~/Scripts/toastr.min.js"></script>
    <script src="~/Scripts/lib/Ajax.js?v=1"></script>
    <script src="~/Scripts/app/email-service.js?v=1"></script>
    @*<script src="~/Scripts/bootstrap-select.min.js"></script>*@
    <script type="text/javascript">
    urlClienteAsignadoLibre = "@Url.Action("ClientesAsignadosLibresSelect", "Cliente")";
    urlBuscarCliente = "@Url.Action("ClientesAsignadosLibres", "Cliente")";
        urlActualizarCartera = "@Url.Action("ActualizarAsignacionClienteVendedor", "Cliente")";
        var ls_table;
    //sClientes = $("#sClientes");
    //LISTAR DEPARTAMENTOS
    //function clientesActivosListar() {
    //    sClientes.html("");//limpiar todas las filas o rows
    //    $.ajax({
    //        destroy: true,
    //        type: "POST",
    //        contentType: "application/json; charset=utf-8",
    //        url: urlClienteAsignadoLibre,
    //        data: JSON.stringify({
    //        }),
    //        dataType: "json",
    //        success: function (result) {
    //            sClientes.append("<option value=''>" + "TODOS LOS CLIENTES" + "</option>");
    //            for (var i = 0; i < result.length; i++) {
    //                sClientes.append("<option value='" + result[i].ruc + "'>" + result[i].razonSocial + "</option>");
    //            }
    //            //document.getElementById("sClientes").setAttribute("onchange", "buscarCliente();");
    //            $('#sClientes').selectpicker({
    //                maxOptions: 2
    //            });
    //            $('#sClientes').selectpicker('refresh');
    //        },
    //        error: function (result) {
    //            alert("Error en javascript...");
    //        }
    //    });
    //    }


        $(document).ready(function () {
        //clientesActivosListar();
        //$('.selectpicker').selectpicker({
        //    size: 5,
        //    title: 'Seleccione una opción'
        //});

        buscarCliente();

        });

        function buscarCliente() {
        //Limpiando la tabla
            $("#table-clientesAsignadosLibres tbody").empty();

        $.ajax({
            destroy: true,
            type: "POST",
            contentType: "application/json; charset=utf-8",
            url: urlBuscarCliente,
            data: JSON.stringify({
                rucCliente: ""//$("#sClientes option:selected").val()
            }),
            dataType: "json",
            success: function (result) {
                for (var i = 0; i < result.length; i++) {
                    var fila = i + 1;
                    if (result[i].asignado == true) {
                        var asignado = "SI";
                        var checkbox = '<input type="checkbox" id="checkbox-' + result[i].ruc + '" checked="checked" onclick="actualizarAsignacionCliente(' + result[i].ruc+');" />'
                    }
                    else {
                        var asignado = "NO";
                        var checkbox = '<input type="checkbox" id="checkbox-' + result[i].ruc + '" onclick="actualizarAsignacionCliente(' + result[i].ruc +');"  />'
                    }

                    //var creditoDisponible = result[i].montoTotalLimite - result[i].montoDeuda;
                    $("#table-clientesAsignadosLibres tbody").append('<tr>' +
                        '<td style="text-align:center; border-right:dashed 0.2px #214820;">' + checkbox + '</td>' +
                        '<td style="display:none;">' + asignado + '</td>' +
                        '<td style="text-align:center; border-right:dashed 0.2px #214820; vertical-align:middle;">' + fila + '</td>' +
                        '<td style="text-align:center; border-right:dashed 0.2px #214820; vertical-align:middle;">' + result[i].ruc +'</td>' +
                        '<td style="text-align:left; border-right:dashed 0.2px #214820; vertical-align:middle;">' + result[i].razonSocial + '</td>' +
                        '<td style="text-align:center; border-right:dashed 0.2px #214820; vertical-align:middle;">' + result[i].sector + '</td>' +
                        '<td style="text-align:center; border-right:dashed 0.2px #214820; vertical-align:middle;">' + result[i].aseguradora + '</td>' +
                        '<td style="text-align:right; border-right:dashed 0.2px #214820; vertical-align:middle;">' + result[i].montoTotalLimite.toLocaleString() + '</td>' +
                        //'<td style="text-align:right; border-right:dashed 0.2px #214820; vertical-align:middle;">' + result[i].montoDeuda.toLocaleString() + '</td>' +
                        //'<td style="text-align:right; border-right:dashed 0.2px #214820; vertical-align:middle;">' + creditoDisponible.toLocaleString() + '</td>' +
                        '<td style="text-align:center; border-right:dashed 0.2px #214820; vertical-align:middle;">' + result[i].departamento + '</td>' +
                        '<td style="text-align:center; border-right:dashed 0.2px #214820; vertical-align:middle;">' + result[i].provincia + '</td>' +
                        '<td style="text-align:center; vertical-align:middle;">' + result[i].distrito + '</td>' +
                        //'<td style="text-align:center; vertical-align:middle;">' + result[i].fechaUltVenta + '</td>' +
                        '</tr > ');
                }
                ls_table = $('#table-clientesAsignadosLibres');

                $('#table-clientesAsignadosLibres').DataTable({
                        order: [[2, 'asc']],
                        "pageLength": 50,
                        "language": {
                            "lengthMenu": "Mostrar _MENU_ registros",
                            "search": "Buscar:",
                            "info": "Mostrando _START_ al _END_ de _TOTAL_ registros",
                            "infoFiltered": "(Filtrado de _MAX_ registros en total)",
                            "zeroRecords": "Sin resultados coincidentes",
                            "paginate": {
                                "first": "Primero",
                                "last": "Último",
                                "next": "Siguiente",
                                "previous": "Anterior"
                            }
                        }
                    });


                //$('#table-clientesAsignadosLibres').DataTable({
                //    columnDefs: [
                //        {
                //            target: 0,
                //            visible: false,
                //            searchable: false,
                //        }
                //    ],
                //});
            },
            error: function (result) {
                alert("Error en javascript...");
            }
        });
        }

        function actualizarAsignacionCliente(ruc) {
            var confirmado = "No";
            var checkbox = $("#checkbox-" + ruc);
            if (checkbox.is(":checked")) {
                var asignar = true;
                if (confirm('¿Está seguro de agregar este cliente a su cartera?')) {
                    confirmado = "Si";
                } else {
                    confirmado = "No";
                }
            }
            else {
                var asignar = false;
                if (confirm('¿Está seguro de quitar este cliente de su cartera?')) {
                    confirmado = "Si";
                } else {
                    confirmado = "No";
                }
            }

            if (confirmado == "Si") {
                $.ajax({
                    destroy: true,
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    url: urlActualizarCartera,
                    data: JSON.stringify({
                        rucCliente: ruc,
                        asignar: asignar
                    }),
                    dataType: "json",
                    success: function (result) {
                        var error = result.error;
                        var mensaje = result.mensaje;
                        if (error == "1") {
                            toastr.error(mensaje);
                        }
                        else {
                            toastr.success(mensaje);
                        }
                    },
                    error: function (result) {
                        alert("Error en javascript...");
                    }
                });
            }
            else {
                buscarCliente();
            }
        }


        function tableToExcel() {
            // Get the column API object
            var column = ls_table.column(0);

            // Toggle the visibility
            column.visible(!column.visible());

            var table = "table-clientesAsignadosLibres"
            var sheetName = "Clientes"
            var fileName = "Mi Cartera de Clientes.xls";

            fileName = fileName;

            var uri = 'data:application/vnd.ms-excel;base64,',
                templateData = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--><meta http-equiv="content-type" content="text/plain; charset=UTF-8"/></head><body><table>{table}</table></body></html>',
                base64Conversion = function (s) { return window.btoa(unescape(encodeURIComponent(s))) },
                formatExcelData = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }

            $("tbody > tr[data-level='0']").show();

            if (!table.nodeType)
                table = document.getElementById(table)

            var ctx = { worksheet: sheetName || 'Worksheet', table: table.innerHTML }

            var element = document.createElement('a');
            element.setAttribute('href', 'data:application/vnd.ms-excel;base64,' + base64Conversion(formatExcelData(templateData, ctx)));
            element.setAttribute('download', fileName);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);

            //Revert action
            column.visible(!column.visible());
        }




    </script>
}