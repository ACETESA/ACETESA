@using System.Configuration;
@model IEnumerable<Acetesa.TomaPedidos.AdminMvc.Models.PedidoDetailViewModel>
@if (Model != null && Model.Any())
{
    <div class="col-xs-12 col-sm-12">Nro. artículos: @Model.Count()</div>
    <table class="table table-striped table-hover" id="table-detail-cotizaciones">
        <thead>
            <tr>
                <th></th>
                <th></th>
                <th style="text-align: right;">Item</th>
                <th>Código</th>
                <th>Descripción</th>
                <th style="text-align: left;">U.M.</th>
                <th style="text-align: right;">Cant. Ped</th>
                <th style="text-align: right;">Peso TM</th>
                <th style="text-align: right;">Precio Lista</th>
                @{var sqlDB3 = new System.Data.SqlClient.SqlConnectionStringBuilder(ConfigurationManager.ConnectionStrings["DefaultConnection"].ConnectionString);
                    if (sqlDB3.InitialCatalog == "ZICO_ERP01")
                    {
                        <th style="text-align: right;">Precio Lista 2</th>
                    }
                    else
                    {
                        <th></th>
                    }
                }
                <th style="text-align: right;">Precio Final</th>
                <th style="text-align: right;">Total</th>
            </tr>
        </thead>
        <tbody>
            @{
                decimal SubTotVta = 0;
                var igv_bo = Model.First().igv_bo;
                var zonaLiberada_bo = Model.First().zonaLiberada_bo;
                var mostrarIGV = zonaLiberada_bo == 1 ? 0 : 1;

            }
            @foreach (var item in Model)
            {
                var sfqCantidad = item.fq_cantidad.ToString("N2");
                var sfmTotal = item.fm_total.ToString("N2");
                var sfmPrecio = item.fm_precio.ToString("N4");
                var sfmPrecio2 = item.fm_precio2.ToString("N4");
                var sfmPrecioFin = item.fm_precio_fin.ToString("N4");
                var sfqPesoTM = item.fq_peso_teorico.ToString("N4");
                SubTotVta += item.fm_total;
                //Para el editar
                var pesoUnit = Convert.ToDecimal(sfqPesoTM.Replace(",", ""));
                var precioTM = ((Convert.ToDecimal(sfmPrecioFin.Replace(",", "")) / pesoUnit) * 1000).ToString("N4").Replace(",", "");
                string s = item.cd_artic;
                var descArticulo = s;
                var PesoTotal = Convert.ToDecimal(sfqPesoTM.Replace(",", "")) * Convert.ToDecimal(sfqCantidad.Replace(",", ""));


            <tr>
                <td>
                    <a title="Editar" class="editar-grilla" href="#" onclick="cargarDatosParaEditarArticulo('@item.cc_artic','@descArticulo','@sfqCantidad','@precioTM','@pesoUnit','@sfmPrecio','@sfmPrecio2','@sfmPrecioFin');"><i class="glyphicon glyphicon-edit"></i></a>
                </td>
                <td>
                    @*@if (!item.EsProforma)
            {*@
                    @Ajax.ActionLink(" ", "EliminarFila",
new { id = item.cc_artic.Trim() },
new AjaxOptions
{
HttpMethod = "GET",
OnBegin = "OnBegin",
OnSuccess = "OnSuccessEliminar",
OnComplete = "OnComplete",
OnFailure = "OnFailure",
UpdateTargetId = "result"
}, new { @id = "btnEliminarFila" + item.cc_artic.Trim(), @class = "glyphicon glyphicon-trash elimina-grilla", @style = "color:#B06251;", @title = "Eliminar", @onclick = "btnEliminar_click()" })
                    @*}*@
                    @*<script>alert("@sfqPesoTM");</script>*@
                </td>
                <td style="text-align: right;">@Html.DisplayFor(modelItem => item.cn_item)</td>
                <td>@Html.DisplayFor(modelItem => item.cc_artic)</td>
                <td>@Html.DisplayFor(modelItem => item.cd_artic)</td>
                <td>@Html.DisplayFor(modelItem => item.cc_unmed)</td>
                <td style="text-align: right; width: 90px;">@Html.DisplayFor(modelItem => sfqCantidad)</td>
                <td style="text-align: right; width: 80px;">@Html.DisplayFor(modelItem => PesoTotal)</td>
                <td style="text-align: right; width: 100px;">@Html.DisplayFor(modelItem => sfmPrecio)</td>
                @{var sqlDB2 = new System.Data.SqlClient.SqlConnectionStringBuilder(ConfigurationManager.ConnectionStrings["DefaultConnection"].ConnectionString);
                    if (sqlDB3.InitialCatalog == "ZICO_ERP01")
                    {
                        <td style="text-align: right; width: 110px;">@Html.DisplayFor(modelItem => sfmPrecio2)</td>
                    }
                    else
                    {
                        <td></td>
                    }
                }
                <td style="text-align: right; width: 100px;">@Html.DisplayFor(modelItem => sfmPrecioFin)</td>
                <td style="text-align: right; width: 40px;">@Html.DisplayFor(modelItem => sfmTotal)</td>
            </tr>
            }



            @*@if (sqlDB.InitialCatalog == "ZICO_ERP01")
                {*@
            @*<tr>
                    <td colspan="9"></td>
                    <td style="text-align: right;"><b>Valor Venta</b></td>
                    <td style="text-align: right;">@SubTotVta.ToString("N2")</td>
                </tr>
                <tr>
                    <td colspan="9"></td>
                    <td style="text-align: right;"><b>IGV</b></td>
                    <td style="text-align: right;">@IgvVta.ToString("N2")</td>
                </tr>*@
            @*}*@
            @*<tr>
                    <td colspan="9"></td>
                    <td style="text-align: right;"><b>Total</b></td>
                    <td style="text-align: right;"><b><i>@TotVta.ToString("N2")</i></b></td>
                </tr>*@
        </tbody>
    </table>

    var sqlDB = new System.Data.SqlClient.SqlConnectionStringBuilder(ConfigurationManager.ConnectionStrings["DefaultConnection"].ConnectionString);
    decimal IgvVta;
    decimal TotVta;
    var igv = 0.18;
    if (igv_bo == 0)
    {

        <script>var js_mostrarIGV = @mostrarIGV;</script>

        if (sqlDB.InitialCatalog == "ZICO_ERP04")
        {
            @*<script>alert(@mostrarIGV);</script>*@


            if (mostrarIGV == 0)
            {
                IgvVta = 0; //SubTotVta * (decimal)(igv);
                TotVta = SubTotVta + IgvVta;
            }
            else
            {
                IgvVta = SubTotVta * (decimal)(igv);
                TotVta = SubTotVta + IgvVta;
            }

        }
        else
        {
            IgvVta = SubTotVta * (decimal)(igv);
            TotVta = SubTotVta + IgvVta;
        }

    }
    else
    {
        TotVta = SubTotVta;
        SubTotVta = TotVta / (decimal)(igv + 1);
        IgvVta = SubTotVta * (decimal)(igv);
    }

    <a hidden id="aSubTotVta">@SubTotVta.ToString("N2")</a>
    <a hidden id="aIgvVta">@IgvVta.ToString("N2")</a>
    <a hidden id="aTotVta">@TotVta.ToString("N2")</a>

}




<script type="text/javascript">
    function btnEliminar_click() {
        var filas = @Model.Count();
            if ((filas - 1) === 0) {
                $("#Tienda option:not(:selected)").prop("disabled", false);
                $("#igv_bo option:not(:selected)").prop("disabled", false);
                $("#cc_moneda option:not(:selected)").prop("disabled", false);
            }
        }


    //Mostramos el Totalizado segun el MOSTRAR IGV
    try {
        //var subtotal = $("#aSubTotVta").text();
        var subtotal = document.getElementById("aSubTotVta").innerText;
        //var igv = $("#aIgvVta").text();
        var igv = document.getElementById("aIgvVta").innerText;
        //var total = $("#aTotVta").text();
        var total = document.getElementById("aTotVta").innerText;
    } catch (error) {
        //console.error(error);
        // expected output: ReferenceError: nonExistentFunction is not defined
        // Note - error messages will vary depending on browser
    }




    //document.addEventListener('DOMContentLoaded', function () {
        setTimeout(function () {
            var tabla = document.getElementById('table-detail-cotizaciones');
            var tbody = tabla.getElementsByTagName('tbody')[0];

            //if (document.getElementById("mostrarIGV_bo").value == "1") {
            if (js_mostrarIGV == "1") {


                var html1 = "<tr>"
                    + '<td colspan="10"></td>'
                    + '<td style="text-align: right;"><b>Valor Venta</b></td>'
                    + '<td style="text-align: right;">' + subtotal + '</td>'
                    + '</tr>' +
                    "<tr>"
                    + '<td colspan="10"></td>'
                    + '<td style="text-align: right;"><b>IGV</b></td>'
                    + '<td style="text-align: right;">' + igv + '</td>'
                    + '</tr>';

                tbody.insertAdjacentHTML('beforeend', html1);


            }

            var html2 = "<tr>"
                + '<td colspan="10"></td>'
                + '<td style="text-align: right;"><b>Total</b></td>'
                + '<td style="text-align: right;"><i>' + total + '</i></td>'
                + '</tr>';

            tbody.insertAdjacentHTML('beforeend', html2);
        }, 3000);
    //}, false);




</script>